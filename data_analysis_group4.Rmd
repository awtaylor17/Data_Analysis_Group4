---
title: "data_analysis_group4"
authors: "Razak Diallo, Lea Glaser, Deja Jones, Alexander Taylor"
date: "2025-12-06"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```
# Load Libraries
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(tidycensus)

```


# Load and clean data
```{r}
state_payments <- read_csv("data/state_payments.csv") |>
  clean_names() |>
  mutate(
    date = ymd_hms(date),
    amount = str_replace_all(amount, "\\$", ""),
    amount = str_replace_all(amount, "\\,", ""),
    amount = as.numeric(amount)
         )
glimpse(state_payments)
```
# Note on data: This dataframe contains the all the payments the State of Maryland made from the 2008 fiscal year to the 2026 fiscal year. Each row is one payment, and contains the date of the payment, the payment's amount, the agency doing the paying, the organization recieving the payment and the zip code of that organization. Before cleaning the data, the "amount" column was not a numeric value and the "date" column was not a date data type.

# Question 1: What is the median income of the zip codes where the top five vendors are located?
# Findings: All five are displayed below. Two of the zip codes have a median income greater than $120,000, one is just under $100,000 and the other, which has the highest amount of payments, has a median income of about $60,000. I would want to look more the last zip code to find because it seems to be an outlier: it has a lower median income but a high amount of payments. One of the zip codes, 10041, has no demographic data. That's because that zip code only incompasses one bulding. Because it is in New York's financial district, I guess this bulding is an office building and not a residential building, so there is no demographic data that can be collected. 
```{r}
# Find zip codes with the top five vendors

state_payments |>
  group_by(date) |>
  summarise(count = n())

q1_top5 <- state_payments |>
  group_by(vendor_zip) |>
  summarise(total_amount = sum(amount)) |>
  arrange(desc(total_amount)) |>
  filter(row_number() <= 5)

# Get median income data
#q1_vars <- load_variables(2023, "acs5", cache = TRUE)
#B19013_001


q1_vars <- load_variables(2023, "acs5", cache = TRUE)

q1_med_income <- get_acs(geography = "zcta", variables = "B19013_001", year = 2023) |>
  rename(
    vendor_zip = GEOID,
    med_income = estimate
  ) |>
  select(vendor_zip, med_income)

# Join dataframes

q1_top5 <- q1_top5 |>
  left_join(q1_med_income)

q1_top5


```

# Question 2: What year did the State of Maryland spend the most? How about the least?
# Findings: The State of Maryland spent the most in 2025, spending $43,703,480,470 and the least was in 2008 (if not counting 2026) where it spent $19,879,214,691.
```{r}
years <- state_payments |>
  group_by(fiscal_year) |>
  summarise(total_spending = sum(amount, na.rm = TRUE)) |>
  arrange(desc(total_spending))

```

# Question 3: What county school system received the most money each year?
# Findings: Over the range of the data set, Prince George's County and Baltimore City fought for first place in state funding for their school systems. 

```{r}
school_system_payments <- state_payments |> 
  mutate(
    vendor_name = str_to_upper(vendor_name)
  ) |> 
  filter(str_detect(vendor_name, "SCHOOL") | 
           str_detect(vendor_name, "PUB SCHOOL") | 
           str_detect(vendor_name, "CPS") | 
           str_detect(vendor_name, "INFANT") & str_detect(vendor_name, "TODD") & str_detect(agency_name, "EDUCATION") | 
           str_detect(vendor_name, "BOARD OF ED") | 
           str_detect(vendor_name, "BD OF ED") |
           vendor_name == "CARROLL COUNTY CAREER & TECHNOLOGY CENTER" | vendor_name == "HCPPS") |> 
  mutate(
    vendor_name = case_when(
        str_detect(vendor_name,"ALLEGANY") ~ "ALLEGANY",
        str_detect(vendor_name,"ANNE ARUN") ~ "ANNE ARUNDEL",
        str_detect(vendor_name,"BALTIMORE CITY") ~ "BALTIMORE CITY",
        str_detect(vendor_name,"BALTIMORE CO") ~ "BALTIMORE",
        str_detect(vendor_name,"CALVERT") ~ "CALVERT",
        str_detect(vendor_name,"CAROLINE") | vendor_name == "CCPS" ~ "CAROLINE",
        str_detect(vendor_name,"CARROLL") ~ "CARROLL",
        str_detect(vendor_name,"CECIL") ~ "CECIL",
        str_detect(vendor_name,"CHARLES") ~ "CHARLES",
        str_detect(vendor_name,"DORCHESTER") ~ "DORCHESTER",
        str_detect(vendor_name,"FCPS") | str_detect(vendor_name, "FREDERICK") ~ "FREDERICK",
        str_detect(vendor_name,"HARFORD") ~ "HARFORD",
        str_detect(vendor_name,"HOWARD") | vendor_name == "HCPPS" ~ "HOWARD",
        str_detect(vendor_name,"KENT") ~ "KENT",
        str_detect(vendor_name,"MONTGOMERY") ~ "MONTGOMERY",
        str_detect(vendor_name,"PRINCE GEORGE") | str_detect(vendor_name,"PG C") ~ "PRINCE GEORGES",
        str_detect(vendor_name,"MARY") ~ "ST MARYS",
        str_detect(vendor_name,"SOMERSET") ~ "SOMERSET",
        str_detect(vendor_name,"TALBOT") ~ "TALBOT",
        str_detect(vendor_name,"WASHINGTON") ~ "WASHINGTON",
        str_detect(vendor_name,"WICOMICO") ~ "WICOMICO",
        str_detect(vendor_name, "WORCESTER") ~ "WORCESTER",
        str_detect(vendor_name, "QUEEN ANNE") ~ "QUEEN ANNES",
        str_detect(vendor_name, "GARRETT") ~ "GARRETT",
        TRUE ~ NA
      )
  ) |>
  drop_na(vendor_name) |> 
  group_by(vendor_name, fiscal_year) |>   
  summarise(
    amount_received = sum(amount)
  ) |> 
  arrange(desc(amount_received)) |> 
  rename(county = vendor_name)

#Year with most funding for each county
school_system_payments |> 
  slice_max(amount_received)

#highest paid school system each year
school_system_payments |> 
  group_by(fiscal_year) |> 
  slice_max(amount_received)
```

# Question 4: Which agency had the largest increase in spending between 2019 and 2025?
# Findings: The Governor's Office for Children had the highest spending increase between 2019 and 2025 at around 87,736% or around $45,427,965. The highest raw number increase was for the Maryland Department of Health at 4,779,327,673.28 or a ~40% increase from 2019. The biggest raw  decrease was for the State Highway Administration at -281,313,823.70. For percentage decrease it goes to the Boards Commissions & Offices at -99.8% followed by the Military Department at -80%.
```{r}

agency_change <- state_payments |> 
  mutate(
    agency_name = case_when(
      agency_name == "MARYLAND DEPARTMENT OF HEALTH, MDH" ~ "MARYLAND DEPARTMENT OF HEALTH",
      agency_name == "DEPT OF VETERANS & MILITARY FAMILIES" ~ "MARYLAND DEPARTMENT OF VETERANS AFFAIRS",
      agency_name == "MARYLAND STATE LOTTERY AGENCY" ~ "MARYLAND LOTTERY AND GAMING CONTROL AGY",
      agency_name == "MD DEPARTMENT OF HUMAN SERVICES" ~ "DEPARTMENT OF HUMAN SERVICES",
      agency_name == "MARYLAND STATE DEPARTMENT OF EDUCATION" ~ "STATE DEPARTMENT OF EDUCATION",
      agency_name == "MARYLAND DEPARTMENT OF LABOR" ~ "DEPARTMENT OF LABOR",
      agency_name == "MD DEPARTMENT OF AGRICULTURE" ~ "DEPARTMENT OF AGRICULTURE",
      agency_name == "ENERGY ADMINISTRATION" ~ "MARYLAND ENERGY ADMINISTRATION",
      agency_name == "DEPARTMENT OF JUVENILE SERVICES-HQ" ~ "DEPARTMENT OF JUVENILE SERVICES",
      agency_name == "Maryland Environmental Service" ~ "MARYLAND ENVIRONMENTAL SERVICE",
      .default = agency_name
    )
  ) |> 
    group_by(agency_name, fiscal_year) |> 
    summarise(
      year_total = sum(amount)
    ) |> filter(fiscal_year == 2019 | fiscal_year == 2025) |> 
    pivot_wider(names_from = fiscal_year, values_from = year_total) |> 
    clean_names() |> 
    rename(spending_2025 = x2025, spending_2019 = x2019) |> 
    mutate(
      change = spending_2025 - spending_2019,
      spending_2025 = replace_na(spending_2025, 0),
      spending_2019 = replace_na(spending_2019, 0),
      perct = change/spending_2019 * 100
    ) |> 
      mutate(across(where(is.numeric), ~replace(., is.infinite(.), 0)))
```

# Question 5: What zip code did each agency spend the most money?
# Findings: There's a lot of interesting data here. For example the Department of Education spent the most in Baltimore City, around the inner harbor. The Department of Health spent the most in Glenn Burnie, where the Baltimore-Washington Medical Center is. Maryland State Police spent the most in 30501, a zip code in Georgia. All of the payments go to a Mansfield Oil Company.
```{r}
agency_county <- state_payments |> 
  group_by(vendor_zip, agency_name) |> 
  summarise(
    total_payments = sum(amount)
  ) |> 
  group_by(agency_name) |> 
  filter(total_payments == max(total_payments)) |> 
  summarise(
    top_zip = vendor_zip,
    amount = total_payments
  ) |> arrange(desc(amount))
```

#Memo Link
https://docs.google.com/document/d/1p8ndP91tI8xR4dsyEjwPeHVeuYGVDtpoiK_XfnI02DY/edit?usp=sharing

